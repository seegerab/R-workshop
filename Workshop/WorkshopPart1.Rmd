---
title: "Workshop part 1"
author: "Abigail Seeger"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set up

First, read in the data.

```{r}
data <- read.csv("C:/Users/u249135/OneDrive - Baylor College of Medicine/Teaching Materials/R-workshop/Workshop/Stool4TB Database for Abi.csv")
```

```{r}
### Create the variable for age
data <- data%>%
  ### Convert the dates to a date data type
  mutate(rf_enroll_date = ymd(rf_enroll_date))%>%
  mutate(rf_dob = ymd(rf_dob))%>%
  mutate(date_diff = time_length(interval(rf_dob, rf_enroll_date), unit = "years"))%>%
  mutate(date_diff = floor(date_diff))%>%
  mutate(age = ifelse(is.na(date_diff), rf_age, date_diff))
```

We'll use `ggplot2` and `dplyr` today. We need to read in the `tidyverse` package (remember, `ggplot2` and `dplyr` are bundled in the `tidyverse` package) to use them.

```{r}
library(tidyverse)
```


# t-test

Today, we're going to use t-tests to compare two independent groups.

Let's investigate whether there is a **statistically significant** different in heart rate at baseline by gender.

There are some assumptions that we need to check in order to conduct this test.

## Step 1. 

Is the data normally distributed? 

We need to check that **each group** (the heart rate for males, and the heart rate for females) is normally distributed.

To check this, we are going to plot a histogram for each group.

We could also check this using the Shapiro-Wilk test.

# Notes

Remember that for a t-test, we need to check a few assumptions. We did that above by looking at histograms of the data. However, there are some tests we conduct to investigate whether the data for each group is normal and has equal variances.

## Normality

To test normality, we can use the `shapiro.test()` function.

As an example, we investigated the normality of respiratory rate by gender for children in our t-test above.

We need to conduct the Shapiro-Wilk test for each group - males and females. Let's start by creating subsets for each group.

```{r}
### Create a subset for children
children_subset <- data%>%
  filter(redcap_event_name == "Baseline")%>%
  filter(age <= 8)
### Create subsets by gender
female_subset <- data%>%
  filter(redcap_event_name == "Baseline")%>%
  filter(rf_gender == "Female")%>%
  filter(age <= 8)
male_subset <- data%>%
  filter(redcap_event_name == "Baseline")%>%
  filter(rf_gender == "Male")%>%
  filter(age <= 8)
### Apply the Shapiro-Wilk test to each subset
shapiro.test(female_subset$bf_respiratoryrate)
shapiro.test(male_subset$bf_respiratoryrate)
```

How do we interpret the results?

The **null hypothesis** is that the data is normally distributed. For each subset, the p-value is **less than 0.05**. In fact, it is so small that R reports *p-value < 2.2e-16* rather than the exact p-value.

Because our p-value is less than 0.05, we reject the null hypothesis that the data is normally distributed. Therefore, the assumption of normality is not met and we should proceed with with **Wilcoxon rank-sum test**. Note that this is the same conclusion we reached by looking at the histograms of the data. 

Here is a reference on this test and more explanation on the code: https://www.sthda.com/english/wiki/normality-test-in-r

For a lot more detail on this test - and also on qqplots, another way we can assess normality - please reference this video: https://www.youtube.com/watch?v=eh9eYLBecWk

## Equal variances

Another assumption for the t-test is that the two groups have equal variances.

To check this, you can use the Levene test. The code for the Levene test is in the `car` package. Let's install the package (remember, we just need to do this once) and use the `library()` function to read in the package.

```{r}
### install.packages("car")
library(car)
```

We will be using the `leveneTest` function from the `car` package. Rather than two subsets, the `leveneTest` function uses the following syntax: 

**leveneTest(numeric variable ~ categorical data, data = data_subset)**

So, we're going to use the **children_subset** we created above.

```{r}
leveneTest(bf_respiratoryrate ~ rf_gender, 
           data = children_subset)
```

How do we interpret these results? The null hypothesis for this test is that the variance of the two groups are equal. Our p-value is **greater than 0.05**. Therefore, we have no evidence to reject the null hypothesis that the variance of the two groups are equal. 

More information on the Levene test can be found here: https://www.sthda.com/english/wiki/compare-multiple-sample-variances-in-r


